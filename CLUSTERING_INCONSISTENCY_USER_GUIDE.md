# LLMèšç±»ä¸ä¸€è‡´æ€§æ£€æµ‹ - ä½¿ç”¨æŒ‡å—

## å¿«é€Ÿå¼€å§‹

å½“ä½ åœ¨LLMèšç±»å»é‡ä¸­é‡åˆ°ç±»ä¼¼é—®é¢˜æ—¶ï¼š
- **rationaleè¯´è¦åˆå¹¶ï¼Œä½†membersåªæœ‰1ä¸ªæˆå‘˜**
- **èšç±»ç»“æœä¸æè¿°ä¸ç¬¦**

è¿™ä¸ªæ–°åŠŸèƒ½ä¼šè‡ªåŠ¨æ£€æµ‹å¹¶è­¦å‘Šè¿™äº›é—®é¢˜ã€‚

## åŠŸèƒ½è¯´æ˜

### è‡ªåŠ¨æ£€æµ‹

ç³»ç»Ÿä¼šåœ¨ä»¥ä¸‹èšç±»æ“ä½œåè‡ªåŠ¨æ£€æµ‹ä¸ä¸€è‡´ï¼š

1. **Tailå®ä½“å»é‡** - `_cluster_candidate_tails_with_llm()`
2. **å…³é”®è¯å»é‡** - å…³é”®è¯èšç±»é˜¶æ®µ
3. **è¾¹å»é‡** - è¾¹èšç±»é˜¶æ®µ

### æ£€æµ‹å†…å®¹

**æ£€æŸ¥æ¨¡å¼ï¼š**
- âœ… rationaleè¯´"åˆå¹¶/ä¸€è‡´/ç­‰åŒ"ï¼Œmembersç¡®å®æœ‰å¤šä¸ªæˆå‘˜ â†’ æ­£å¸¸
- âŒ rationaleè¯´"åˆå¹¶/ä¸€è‡´/ç­‰åŒ"ï¼Œmembersåªæœ‰1ä¸ªæˆå‘˜ â†’ **ä¸ä¸€è‡´ï¼**
- âœ… rationaleè¯´"ç‹¬ç«‹/ä¸åŒ/åˆ†å¼€"ï¼Œmembersåªæœ‰1ä¸ªæˆå‘˜ â†’ æ­£å¸¸

**å…³é”®è¯æ£€æµ‹ï¼ˆä¸­è‹±æ–‡ï¼‰ï¼š**
- åˆå¹¶ï¼š`åº”è¯¥?åˆå¹¶`ã€`å¯åˆå¹¶`ã€`å®Œå…¨ä¸€è‡´`ã€`åŒä¹‰`ã€`identical`ã€`equivalent`ã€`same`
- åˆ†å¼€ï¼š`åº”è¯¥?åˆ†å¼€`ã€`ä¿æŒ.*ç‹¬ç«‹`ã€`ä¸åŒ`ã€`distinct`ã€`different`

## å¦‚ä½•ä½¿ç”¨

### 1. æ­£å¸¸è¿è¡Œå»é‡

æ— éœ€ä»»ä½•é…ç½®æ”¹åŠ¨ï¼Œç³»ç»Ÿè‡ªåŠ¨æ£€æµ‹ï¼š

```bash
python main.py --dataset demo --mode all
```

### 2. æŸ¥çœ‹æ—¥å¿—è¾“å‡º

å¦‚æœå‘ç°ä¸ä¸€è‡´ï¼Œæ—¥å¿—ä¼šè¾“å‡ºè­¦å‘Šï¼š

```
WARNING: Clustering inconsistency detected: Cluster 4 has 1 member [10] but rationale says merge: 
'"å¢åŠ ç›¸ä½ç¼–ç æ–¹å‘çš„çŸ©é˜µ"å³æ‰©å¤§ç›¸ä½ç¼–ç æ­¥æ•°ï¼Œä¸ç»„1/ç»„2æ‰€æŒ‡æ“ä½œå®Œå…¨ä¸€è‡´ï¼Œä¿¡æ¯æ— å·®å¼‚ï¼Œå¯åˆå¹¶ã€‚'

WARNING: Found 1 clustering inconsistencies. These are likely LLM output errors.
```

### 3. æ£€æŸ¥ä¸ä¸€è‡´æ•°é‡

è¿è¡Œåæ£€æŸ¥æ—¥å¿—ï¼š

```bash
# ç»Ÿè®¡ä¸ä¸€è‡´æ•°é‡
grep "Clustering inconsistency" logs/construction.log | wc -l

# æŸ¥çœ‹è¯¦ç»†ä¿¡æ¯
grep -A 2 "Clustering inconsistency" logs/construction.log
```

### 4. åˆ†æå’Œå¤„ç†

**å°‘é‡ä¸ä¸€è‡´ï¼ˆ<5%ï¼‰ï¼š**
- å±äºæ­£å¸¸æƒ…å†µï¼ŒLLMå¶å°”ä¼šçŠ¯é”™
- ç³»ç»Ÿä¼šè®°å½•ä½†ä¸å½±å“è¿è¡Œ
- å¯ä»¥å¿½ç•¥æˆ–æ‰‹åŠ¨æ£€æŸ¥

**å¤§é‡ä¸ä¸€è‡´ï¼ˆ>10%ï¼‰ï¼š**
- éœ€è¦ä¼˜åŒ–promptæˆ–è°ƒæ•´LLMé…ç½®
- å‚è€ƒä¸‹é¢çš„"ä¼˜åŒ–å»ºè®®"

## æµ‹è¯•ç¤ºä¾‹

è¿è¡Œæµ‹è¯•è„šæœ¬éªŒè¯åŠŸèƒ½ï¼š

```bash
python3 test_clustering_inconsistency.py
```

è¾“å‡ºç¤ºä¾‹ï¼š

```
================================================================================
æµ‹è¯•æ¡ˆä¾‹1: ç”¨æˆ·æŠ¥å‘Šçš„æˆªæ–­ä¼ªå½±è§£å†³æ–¹æ¡ˆå»é‡é—®é¢˜
================================================================================

å‘ç° 1 å¤„ä¸ä¸€è‡´

âŒ ä¸ä¸€è‡´ #3:
   ç±»å‹: singleton_but_should_merge
   æˆå‘˜: [4]
   å¼•ç”¨çš„ç»„: [0, 1]
   ç†ç”±: "å¢åŠ ç›¸ä½ç¼–ç æ–¹å‘çš„çŸ©é˜µ"å³æ‰©å¤§ç›¸ä½ç¼–ç æ­¥æ•°ï¼Œä¸ç»„1/ç»„2æ‰€æŒ‡æ“ä½œå®Œå…¨ä¸€è‡´...
   ä¸¥é‡æ€§: high

ğŸ’¡ ä¿®å¤å»ºè®®:
   - å°†æˆå‘˜ [4] åˆå¹¶åˆ° ç»„1, ç»„2
```

## ä¼˜åŒ–å»ºè®®

### å½“ä¸ä¸€è‡´ç‡è¾ƒé«˜æ—¶

**1. è°ƒæ•´Promptï¼ˆå·²è‡ªåŠ¨åº”ç”¨ï¼‰**

ç³»ç»Ÿå·²ç»æ”¹è¿›äº†èšç±»promptï¼Œæ˜ç¡®è¦æ±‚rationaleä¸membersä¸€è‡´ã€‚å¦‚æœä»æœ‰é—®é¢˜ï¼Œå¯ä»¥è¿›ä¸€æ­¥è°ƒæ•´ï¼š

```python
# åœ¨ config/base_config.yaml ä¸­æ·»åŠ è‡ªå®šä¹‰prompt
semantic_dedup:
  clustering_llm:
    custom_prompt: "ä½ çš„è‡ªå®šä¹‰èšç±»prompt..."
```

**2. æ›´æ¢æ›´å¼ºçš„LLMæ¨¡å‹**

```yaml
# config/base_config.yaml
semantic_dedup:
  clustering_llm:
    api_name: "gpt-4"  # ä»gpt-3.5å‡çº§åˆ°gpt-4
    temperature: 0.3   # é™ä½temperatureæé«˜ä¸€è‡´æ€§
```

**3. è°ƒæ•´èšç±»ç­–ç•¥**

```yaml
semantic_dedup:
  clustering_method: "embedding"  # æ”¹ç”¨embeddingèšç±»ï¼Œé¿å…LLMé”™è¯¯
  # æˆ–
  clustering_method: "llm"
  embedding_threshold: 0.85  # æé«˜é˜ˆå€¼ï¼Œå‡å°‘è¾¹ç•Œcase
```

**4. å¯ç”¨Few-shot Learning**

åœ¨promptä¸­æ·»åŠ æ­£ç¡®ç¤ºä¾‹ï¼š

```python
# åœ¨DEFAULT_LLM_CLUSTERING_PROMPTä¸­æ·»åŠ 
"CORRECT EXAMPLE:\n"
"Input: [1] 'NYC', [2] 'New York City', [3] 'Paris'\n"
"Output:\n"
"{{\n"
"  \"clusters\": [\n"
"    {{\"members\": [1, 2], \"description\": \"These refer to the same city and should be merged\"}},\n"
"    {{\"members\": [3], \"description\": \"Different city, keep separate\"}}\n"
"  ]\n"
"}}\n"
```

## å¸¸è§é—®é¢˜

### Q1: æ£€æµ‹åˆ°ä¸ä¸€è‡´ä¼šå½±å“ç»“æœå—ï¼Ÿ

**A:** ä¸ä¼šè‡ªåŠ¨ä¿®æ”¹ç»“æœã€‚ç³»ç»Ÿåªè®°å½•è­¦å‘Šï¼Œä¸ä¼šè‡ªåŠ¨åˆå¹¶ã€‚è¿™æ˜¯ä¸ºäº†ä¿è¯å®‰å…¨æ€§ï¼Œé¿å…è¯¯åˆå¹¶ã€‚

### Q2: å¦‚ä½•æ‰‹åŠ¨ä¿®å¤ä¸ä¸€è‡´ï¼Ÿ

**A:** 
1. æŸ¥çœ‹æ—¥å¿—æ‰¾åˆ°ä¸ä¸€è‡´çš„cluster ID
2. æ£€æŸ¥rationaleåˆ¤æ–­åº”è¯¥åˆå¹¶åˆ°å“ªä¸ªç»„
3. æ ¹æ®å®é™…æƒ…å†µï¼Œå¯ä»¥ï¼š
   - é‡æ–°è¿è¡Œå¹¶è°ƒæ•´é…ç½®
   - åœ¨åå¤„ç†é˜¶æ®µæ‰‹åŠ¨åˆå¹¶èŠ‚ç‚¹
   - æ¥å—ç°çŠ¶ï¼ˆå¦‚æœå½±å“ä¸å¤§ï¼‰

### Q3: èƒ½å¦å¯ç”¨è‡ªåŠ¨ä¿®å¤ï¼Ÿ

**A:** å½“å‰ç‰ˆæœ¬ä¸ºå®‰å…¨è€ƒè™‘ï¼Œä¸æ”¯æŒè‡ªåŠ¨ä¿®å¤ã€‚æœªæ¥ç‰ˆæœ¬å¯èƒ½ä¼šæ·»åŠ ï¼š
- åŠè‡ªåŠ¨ä¿®å¤ï¼ˆæä¾›å»ºè®®ï¼Œç”¨æˆ·ç¡®è®¤ï¼‰
- åŸºäºè§„åˆ™çš„å®‰å…¨ä¿®å¤ï¼ˆåªä¿®å¤æ˜ç¡®çš„caseï¼‰

### Q4: å¦‚ä½•å‡å°‘ä¸ä¸€è‡´å‘ç”Ÿï¼Ÿ

**A:** 
1. âœ… ä½¿ç”¨æ›´å¼ºçš„LLMæ¨¡å‹ï¼ˆGPT-4 > GPT-3.5ï¼‰
2. âœ… é™ä½temperatureï¼ˆ0.3æ¯”0.7æ›´ç¨³å®šï¼‰
3. âœ… æé«˜embedding_thresholdï¼ˆå‡å°‘éœ€è¦LLMåˆ¤æ–­çš„caseï¼‰
4. âœ… æ·»åŠ few-shot examples
5. âœ… å®šæœŸreviewæ—¥å¿—ï¼Œç§¯ç´¯caseä¼˜åŒ–prompt

## æŠ€æœ¯ç»†èŠ‚

### éªŒè¯å‡½æ•°ä½ç½®

```python
# models/constructor/kt_gen.py

def _validate_and_fix_clustering_inconsistencies(
    self, clusters: list, cluster_details: list, 
    descriptions: list, index_offset: int
) -> tuple:
    """éªŒè¯å¹¶ä¿®å¤èšç±»ç»“æœä¸­çš„ä¸ä¸€è‡´"""
    # è¯¦ç»†å®ç°è§æºç 
```

### é›†æˆç‚¹

éªŒè¯é€»è¾‘å·²é›†æˆåˆ°æ‰€æœ‰LLMèšç±»è§£æå‡½æ•°ï¼š
- `_cluster_candidate_tails_with_llm()`
- `_parse_keyword_clustering_results()`
- `_parse_clustering_results()`

### æ—¥å¿—çº§åˆ«

```python
logger.warning(  # ä½¿ç”¨WARNINGçº§åˆ«
    "Clustering inconsistency detected: Cluster %d has 1 member but rationale says merge",
    cluster_idx
)
```

## ç›¸å…³æ–‡æ¡£

- **è¯¦ç»†æŠ€æœ¯æ–‡æ¡£**: `LLM_CLUSTERING_INCONSISTENCY_FIX.md`
- **æµ‹è¯•è„šæœ¬**: `test_clustering_inconsistency.py`
- **æºç **: `models/constructor/kt_gen.py`

## åé¦ˆå’Œæ”¹è¿›

å¦‚æœä½ å‘ç°ï¼š
- æ–°çš„ä¸ä¸€è‡´æ¨¡å¼
- è¯¯æŠ¥ï¼ˆæ­£å¸¸caseè¢«æ ‡è®°ä¸ºä¸ä¸€è‡´ï¼‰
- å…¶ä»–é—®é¢˜

è¯·è®°å½•caseå¹¶åé¦ˆï¼Œå¸®åŠ©æˆ‘ä»¬æ”¹è¿›æ£€æµ‹é€»è¾‘ã€‚

---

**æ›´æ–°æ—¥æœŸ**: 2025-10-23  
**ç‰ˆæœ¬**: 1.0
