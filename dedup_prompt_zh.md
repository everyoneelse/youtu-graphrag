# LLM去重Prompt中文翻译（最终版 v2）

## 重大问题发现：部分-整体关系错误合并

### ❌ 严重错误案例

**LLM错误输出：**
```json
{
  "representative": "颈椎",
  "duplicates": ["胸椎", "腰椎"],
  "rationale": "颈椎、胸椎、腰椎三者均指脊柱的不同节段，但在原文语境中它们被并列列举，
               共同说明'颈、胸、腰椎'是流动伪影常见的解剖部位，
               属于同一整体概念'脊柱'的组成部分。将三者合并为'脊柱'可保留全部信息且避免冗余。"
}
```

**错误分析：**
- 颈椎 ≠ 胸椎 ≠ 腰椎（三个**完全不同的实体**）
- 它们是脊柱的**不同部分**，不是同一个东西的不同名称
- LLM错误地将"部分-整体关系"理解为"应该合并"

**类比说明这个错误的荒谬性：**
| 错误合并 | 错误理由 | 为什么荒谬 |
|---------|---------|-----------|
| "颈椎"+"胸椎"+"腰椎" → "脊柱" | "都是脊柱的组成部分" | 相当于说三个不同的部分是同一个东西 |
| "头部"+"躯干"+"四肢" → "人体" | "都是人体的组成部分" | 头 ≠ 躯干 ≠ 四肢 |
| "北京"+"上海"+"广州" → "中国城市" | "都是中国的城市" | 三个不同的城市 |
| "心脏"+"肝脏"+"肺脏" → "内脏器官" | "都是内脏器官" | 三个不同的器官 |

---

## 问题根源

虽然原prompt中有：
```
✗ 同一集合的一部分："X, Y ∈ 集合_S" → 集合成员资格 ≠ 元素同一性
```

但这条规则**不够明确和醒目**，LLM仍然犯了以下错误：
1. 将"并列列举"理解为应该合并的信号
2. 将"部分-整体关系"理解为应该合并的信号
3. 将"共同构成"理解为应该合并的信号

---

## 解决方案：新增明确的禁止规则

### 新增禁止合并理由（英文版）

```
PROHIBITED MERGE REASONS (these are NOT valid reasons to merge):
✗ Shared relation: "Both satisfy R with H" → NOT sufficient for coreference
✗ Semantic similarity: "X and Y are similar/related" → similarity ≠ identity
✗ Same category: "Both are type T" → category membership ≠ entity identity
✗ Co-occurrence: "X and Y appear together" → contextual proximity ≠ coreference
✗ Listed together: "X, Y, Z are enumerated together" → enumeration ≠ coreference  【新增】
✗ Part-whole relationship: "X and Y are parts of Z" → being parts of same whole ≠ identity  【新增】
   • Example: 'cervical spine', 'thoracic spine', 'lumbar spine' are DIFFERENT parts of spine
   • Example: 'head', 'torso', 'limbs' are DIFFERENT parts of human body
✗ Collective representation: "X, Y, Z together form/represent W" → components ≠ whole  【新增】
✗ Functional relationship: "X causes/affects/contains Y" → relationship ≠ identity
✗ Shared properties: "X and Y have property P" → property sharing ≠ entity identity
✗ Set membership: "X, Y ∈ Set_S" → being in same set ≠ being same element
```

### 新增禁止合并理由（中文版）

```
禁止的合并理由（这些不是合并的有效理由）：
✗ 共享关系："都满足与H的关系R" → 不足以构成共指
✗ 语义相似："X和Y相似/相关" → 相似性 ≠ 同一性
✗ 相同类别："都是类型T" → 类别成员资格 ≠ 实体同一性
✗ 共现："X和Y一起出现" → 上下文接近 ≠ 共指
✗ 并列列举："X、Y、Z被一起列举" → 列举 ≠ 共指  【新增】
✗ 部分-整体关系："X和Y是Z的组成部分" → 是同一整体的部分 ≠ 同一性  【新增】
   • 示例：'颈椎'、'胸椎'、'腰椎'是脊柱的不同部分，不应合并
   • 示例：'头部'、'躯干'、'四肢'是人体的不同部分，不应合并
✗ 集合表示："X、Y、Z共同构成/代表W" → 组成部分 ≠ 整体  【新增】
✗ 功能关系："X导致/影响/包含Y" → 关系 ≠ 同一性
✗ 共享属性："X和Y有属性P" → 属性共享 ≠ 实体同一性
✗ 集合成员资格："X, Y ∈ 集合_S" → 在同一集合中 ≠ 是同一元素
```

---

## 核心原则重申

### 什么时候应该合并？

**只有一种情况：X和Y是同一个实体的不同名称/表达**

- ✅ "SE序列" = "自旋回波序列"（同一事物的缩写和全称）
- ✅ "NYC" = "New York City"（同一城市的不同名称）
- ✅ "H₂O" = "水"（同一物质的不同表达）
- ✅ "北京" = "Beijing"（同一城市的不同语言）

### 什么时候不应该合并？

**所有其他情况，包括但不限于：**

#### 1. 部分-整体关系
- ❌ "颈椎" ≠ "胸椎" ≠ "腰椎"（同一整体的不同部分）
- ❌ "头部" ≠ "躯干" ≠ "四肢"（人体的不同部分）
- ❌ "前叶" ≠ "后叶"（垂体的不同部分）

#### 2. 类别成员关系
- ❌ "北京" ≠ "上海"（同一类别的不同成员）
- ❌ "苹果" ≠ "香蕉"（都是水果，但不同）
- ❌ "心脏" ≠ "肝脏"（都是器官，但不同）

#### 3. 相似/相关关系
- ❌ "高血压" ≠ "低血压"（相关但不同的疾病）
- ❌ "MRI" ≠ "CT"（都是影像检查，但不同）
- ❌ "左肺" ≠ "右肺"（相似但不同的结构）

#### 4. 因果/包含关系
- ❌ "病因" ≠ "症状"（因果关系，不是同一事物）
- ❌ "疾病" ≠ "并发症"（包含关系，不是同一事物）

#### 5. 并列列举
- ❌ 仅仅因为"X、Y、Z在文中被一起列举"不意味着应该合并
- ❌ 仅仅因为"X、Y、Z共同说明某个概念"不意味着应该合并

---

## 判断流程（决策树）

```
对于候选对 (X, Y):

1. 问：X和Y是否指代完全相同的实体？
   ├─ 是 → 进入步骤2
   └─ 否 → 不合并 ❌
   
2. 问：X和Y能否在所有语境下互换而不改变含义？
   ├─ 是 → 进入步骤3
   └─ 否 → 不合并 ❌
   
3. 问：X和Y的区别是否仅在于语言表达形式？
   ├─ 是 → 合并 ✅
   └─ 否 → 不合并 ❌

常见陷阱检查：
- X和Y是同一整体的不同部分？ → 不合并 ❌
- X和Y被并列列举？ → 不合并 ❌
- X和Y属于同一类别？ → 不合并 ❌
- X和Y共同构成某物？ → 不合并 ❌
- X和Y只是相关/相似？ → 不合并 ❌
```

---

## 替换测试（最可靠的判断方法）

**方法：尝试在句子中替换，看含义是否改变**

### 示例 1：应该合并 ✅
- 原句："需要使用**SE序列**进行扫描"
- 替换："需要使用**自旋回波序列**进行扫描"
- 结果：含义完全相同 → 应该合并

### 示例 2：不应该合并 ❌
- 原句："**颈椎**、**胸椎**、**腰椎**都可能出现病变"
- 尝试替换："**颈椎**、**颈椎**、**颈椎**都可能出现病变"
- 结果：含义完全改变了！原文是说三个不同部位都可能病变，替换后变成只说颈椎 → 不应该合并

### 示例 3：不应该合并 ❌
- 原句："流动伪影常见于**颈椎**、**胸椎**、**腰椎**"
- 尝试替换："流动伪影常见于**脊柱**"
- 结果：虽然语义相近，但信息丢失了（原文明确指出三个具体部位）→ 不应该合并

---

## 代表性表达选择原则（保持不变）

### 通用原则（按优先级）

```
a) 信息完整性：优先选择传达更多信息的表达
   • 完整形式 > 缩写（例如：'磁共振成像' > 'MRI'）
   • 完整名称 > 部分名称（例如：'北京市' > '北京'）

b) 自解释性：优先选择无需领域知识即可理解的表达
   • 描述性术语 > 技术代码（例如：'高血压' > 'I10'）
   • 通用名称 > 化学式（例如：在通用语境下，'水' > 'H₂O'）

c) 规范性：优先选择该领域的标准/官方形式
   • 官方名称 > 非正式名称
   • 现行名称 > 已废弃名称

d) 无歧义性：优先选择歧义较少的表达
   • 特定术语 > 通用术语（例如：在医学语境下，'乙酰水杨酸' > '阿司匹林'）

e) 当原则冲突时，根据知识图谱的目标受众确定优先级
```

### 禁止的选择标准

```
禁止的选择标准 - 不要基于以下特征选择代表：
   ✗ 形式特征（与含义无关的表面特征）：
     例如：长度、简洁性、紧凑性、字符数
   ✗ 位置特征（任意排序或位置）：
     例如：字母顺序、索引位置、文本中出现顺序
   ✗ 频率特征（统计出现模式）：
     例如：出现频率、哪个先被提及/提及更多
   ✗ 主观特征（个人或模型特定的偏好）：
     例如：熟悉度、处理难度、个人偏好

通用原则：代表选择必须基于语义和信息标准，
而不是基于任意、统计或形式特征。选择传达最完整和易接近信息的表达，
无论其长度或频率如何。
```

---

## 改进历程总结

### 问题演化

| 版本 | 发现的问题 | 问题类型 | 解决方案 |
|------|-----------|---------|---------|
| v1 | LLM选择"SE序列"而非"自旋回波序列" | 代表选择错误 | 添加通用选择原则 + 禁止简洁性标准 |
| v2 | LLM将"颈椎、胸椎、腰椎"错误合并 | 合并判断错误 | 明确禁止部分-整体关系、并列列举等错误理由 |

### 设计理念演进

1. **第1次迭代**：从模糊规则到明确原则
   - 从："选择最具信息量的表达"
   - 到："5个明确的优先级原则（信息完整性、自解释性、规范性、无歧义性、受众适配）"

2. **第2次迭代**：从case-specific到通用禁止
   - 从：列举具体错误（"简洁性"、"频率"等）
   - 到：定义错误类别（形式特征、位置特征、频率特征、主观特征）

3. **第3次迭代**：从正面指导到正负结合
   - 正面：告诉LLM应该基于什么原则（语义、信息标准）
   - 负面：明确告诉LLM不应该基于什么（部分-整体、并列列举、集合成员等）
   - 增加具体示例帮助理解

### 核心设计原则

✅ **通用性** - 不针对具体案例，而是定义通用原则和类别  
✅ **可扩展性** - 遇到新情况不需要修改prompt，原则可推广应用  
✅ **约束性** - 正面指导 + 负面约束，双重保障  
✅ **可解释性** - 提供具体示例和类比，帮助LLM理解  
✅ **鲁棒性** - 通过多层检查机制（替换测试、决策树）提高准确性  

---

## 预期效果

### 对于"SE序列" vs "自旋回波序列"

```json
{
  "representative": "自旋回波序列",  ✅
  "duplicates": ["SE序列"],
  "rationale": "二者指代完全相同的MRI脉冲序列，仅在表达形式上有差异。
               根据信息完整性原则，选择完整形式'自旋回波序列'作为代表，
               因为它具有更好的自解释性，无需领域知识即可理解。"
}
```

### 对于"颈椎" vs "胸椎" vs "腰椎"

```json
{
  "groups": [
    {"members": [4], "representative": 4, "rationale": "颈椎"},
    {"members": [5], "representative": 5, "rationale": "胸椎"},
    {"members": [6], "representative": 6, "rationale": "腰椎"}
  ],
  "explanation": "颈椎、胸椎、腰椎是脊柱的三个不同解剖部位，
                 虽然被并列列举，但它们是不同的实体（部分-整体关系），
                 不满足替换测试，因此不应合并。"
}
```

---

## 结论

通过三次迭代改进，我们的prompt现在：

1. ✅ **能处理代表选择问题**：优先完整形式而非缩写
2. ✅ **能避免部分-整体混淆**：不会将"颈椎、胸椎、腰椎"错误合并
3. ✅ **能避免并列列举误导**：不会因为"一起列举"就合并
4. ✅ **能避免集合成员混淆**：不会因为"属于同一类别"就合并
5. ✅ **基于通用原则**：可推广到未见过的情况
6. ✅ **有明确约束**：正面指导 + 负面禁止

这是一个**通用的、鲁棒的、可扩展的**去重prompt设计。
