# Tailå»é‡åº”ç”¨ - è¯¦ç»†å®ç°è§£é‡Š

æœ¬æ–‡æ¡£è¯¦ç»†è§£é‡Š `apply_tail_dedup_results.py` ä¸­å››ä¸ªæ ¸å¿ƒåŠŸèƒ½çš„å®ç°åŸç†ã€å¤„ç†æµç¨‹å’Œè¾¹ç•Œæƒ…å†µã€‚

---

## åŠŸèƒ½1ï¼šæ›¿æ¢ä¸‰å…ƒç»„ï¼ˆEdgesï¼‰ä¸­çš„TailèŠ‚ç‚¹

### ğŸ“‹ åŠŸèƒ½è¯´æ˜

å¯¹äºå›¾ä¸­çš„æ¯æ¡è¾¹ï¼ˆä¸‰å…ƒç»„ï¼‰ï¼Œå¦‚æœå…¶tailèŠ‚ç‚¹ï¼ˆç›®æ ‡èŠ‚ç‚¹ï¼‰å±äºæŸä¸ªå»é‡clusterï¼Œåˆ™å°†è¯¥è¾¹çš„tailæ›¿æ¢ä¸ºclusterçš„ä»£è¡¨èŠ‚ç‚¹ã€‚

### ğŸ” å®ç°é€»è¾‘

```python
def apply_to_edges(self) -> None:
    """åº”ç”¨å»é‡æ˜ å°„åˆ°æ‰€æœ‰è¾¹"""
    edges_to_add = []      # å¾…æ·»åŠ çš„æ–°è¾¹ï¼ˆä½¿ç”¨ä»£è¡¨èŠ‚ç‚¹ï¼‰
    edges_to_remove = []   # å¾…åˆ é™¤çš„æ—§è¾¹ï¼ˆä½¿ç”¨åŸèŠ‚ç‚¹ï¼‰
    
    # éå†å›¾ä¸­æ‰€æœ‰çš„è¾¹
    for u, v, key, data in self.graph.edges(keys=True, data=True):
        # u: æºèŠ‚ç‚¹ID (head)
        # v: ç›®æ ‡èŠ‚ç‚¹ID (tail)
        # key: è¾¹çš„keyï¼ˆMultiDiGraphå…è®¸å¤šé‡è¾¹ï¼‰
        # data: è¾¹çš„å±æ€§å­—å…¸ï¼ˆåŒ…å«relationç­‰ï¼‰
        
        # æ­¥éª¤1: æŸ¥æ‰¾tailèŠ‚ç‚¹çš„ä»£è¡¨èŠ‚ç‚¹
        v_rep = self._get_representative(v)
        
        # æ­¥éª¤2: å¦‚æœéœ€è¦æ›¿æ¢ï¼ˆä»£è¡¨èŠ‚ç‚¹ä¸æ˜¯è‡ªå·±ï¼‰
        if v_rep != v:
            relation = data.get('relation', '')
            
            # æ­¥éª¤3: æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨ç›¸åŒçš„è¾¹
            edge_exists = False
            if self.graph.has_edge(u, v_rep):
                # éå†uâ†’v_repä¹‹é—´çš„æ‰€æœ‰è¾¹
                for edge_key, edge_data in self.graph[u][v_rep].items():
                    if edge_data.get('relation') == relation:
                        edge_exists = True
                        break
            
            # æ­¥éª¤4: åªæœ‰ä¸å­˜åœ¨æ—¶æ‰æ·»åŠ æ–°è¾¹
            if not edge_exists:
                edges_to_add.append((u, v_rep, data))
            
            # æ­¥éª¤5: æ ‡è®°åˆ é™¤æ—§è¾¹
            edges_to_remove.append((u, v, key))
            self.stats['edges_updated'] += 1
    
    # æ­¥éª¤6: æ‰¹é‡åº”ç”¨ä¿®æ”¹ï¼ˆå…ˆåˆ ååŠ ï¼‰
    for u, v, key in edges_to_remove:
        self.graph.remove_edge(u, v, key)
    
    for u, v, data in edges_to_add:
        self.graph.add_edge(u, v, **data)
```

### ğŸ“Š å¤„ç†ç¤ºä¾‹

#### ç¤ºä¾‹1ï¼šåŸºæœ¬æ›¿æ¢

**åŸå§‹å›¾**ï¼š
```
é­”è§’æ•ˆåº” --è§£å†³æ–¹æ¡ˆä¸º--> å¢åŠ TEå€¼ (chunk: PHuCr1nf)
é­”è§’æ•ˆåº” --è§£å†³æ–¹æ¡ˆä¸º--> å»¶é•¿TE (chunk: IwfMagF6)
é­”è§’æ•ˆåº” --è§£å†³æ–¹æ¡ˆä¸º--> å»¶é•¿TEå€¼ (chunk: Dwjxk2M8)
```

**Clusterä¿¡æ¯**ï¼š
```json
{
  "member": [
    "å¢åŠ TEå€¼ (chunk id: PHuCr1nf) [entity]",
    "å»¶é•¿TE (chunk id: IwfMagF6) [entity]",
    "å»¶é•¿TEå€¼ (chunk id: Dwjxk2M8) [entity]"  // ä»£è¡¨èŠ‚ç‚¹
  ]
}
```

**å¤„ç†è¿‡ç¨‹**ï¼š

| æ­¥éª¤ | è¾¹ | æ“ä½œ | åŸå›  |
|------|-----|------|------|
| 1 | é­”è§’æ•ˆåº”â†’å¢åŠ TEå€¼ | åˆ é™¤ï¼Œæ·»åŠ â†’å»¶é•¿TEå€¼ | å¢åŠ TEå€¼æ˜ å°„åˆ°å»¶é•¿TEå€¼ |
| 2 | é­”è§’æ•ˆåº”â†’å»¶é•¿TE | åˆ é™¤ï¼Œæ·»åŠ â†’å»¶é•¿TEå€¼ | å»¶é•¿TEæ˜ å°„åˆ°å»¶é•¿TEå€¼ |
| 3 | é­”è§’æ•ˆåº”â†’å»¶é•¿TEå€¼ | æ£€æŸ¥å‘ç°å·²å­˜åœ¨ï¼Œåªåˆ é™¤ä¸æ·»åŠ  | é¿å…é‡å¤ |

**å»é‡å**ï¼š
```
é­”è§’æ•ˆåº” --è§£å†³æ–¹æ¡ˆä¸º--> å»¶é•¿TEå€¼ (chunk: Dwjxk2M8)
```

#### ç¤ºä¾‹2ï¼šé¿å…é‡å¤è¾¹

**åŸå§‹å›¾**ï¼š
```
è‚ºç‚ --ç—‡çŠ¶åŒ…æ‹¬--> å‘çƒ­
è‚ºç‚ --ç—‡çŠ¶åŒ…æ‹¬--> å‘çƒ§  // "å‘çƒ§"æ˜ å°„åˆ°"å‘çƒ­"
```

**å¤„ç†**ï¼š
1. å¤„ç†"è‚ºç‚â†’å‘çƒ§"è¾¹
2. æŸ¥æ‰¾ä»£è¡¨ï¼šå‘çƒ§ â†’ å‘çƒ­
3. æ£€æŸ¥"è‚ºç‚â†’å‘çƒ­"æ˜¯å¦å­˜åœ¨ï¼š**æ˜¯**
4. **ä¸æ·»åŠ **æ–°è¾¹ï¼Œåªåˆ é™¤"è‚ºç‚â†’å‘çƒ§"

**ç»“æœ**ï¼šåªä¿ç•™ä¸€æ¡è¾¹

### ğŸ”§ å…³é”®å‡½æ•°ï¼š`_get_representative()`

```python
def _get_representative(self, node_id: str) -> str:
    """è·å–èŠ‚ç‚¹çš„ä»£è¡¨èŠ‚ç‚¹"""
    # 1. è·å–èŠ‚ç‚¹æ•°æ®
    node_data = self.graph.nodes.get(node_id)
    if not node_data:
        return node_id  # èŠ‚ç‚¹ä¸å­˜åœ¨ï¼Œè¿”å›åŸID
    
    # 2. æå–èŠ‚ç‚¹å±æ€§
    props = node_data.get('properties', {})
    name = props.get('name', '')
    chunk_id = props.get('chunk id', '')
    label = node_data.get('label', '')
    
    # 3. æ„é€ èŠ‚ç‚¹æ ‡è¯†ç¬¦å­—ç¬¦ä¸²
    if chunk_id:
        node_str = f"{name} (chunk id: {chunk_id}) [{label}]"
    else:
        node_str = f"{name} [{label}]"
    
    # 4. æŸ¥æ‰¾æ˜ å°„
    if node_str not in self.node_mapping:
        return node_id  # ä¸åœ¨æ˜ å°„ä¸­ï¼Œè¿”å›åŸID
    
    # 5. è·å–ä»£è¡¨æ ‡è¯†ç¬¦
    rep_str = self.node_mapping[node_str]
    
    if rep_str == node_str:
        return node_id  # ä»£è¡¨æ˜¯è‡ªå·±
    
    # 6. åœ¨å›¾ä¸­æŸ¥æ‰¾ä»£è¡¨èŠ‚ç‚¹
    rep_node_id = self._find_node_by_identifier(rep_str)
    
    if rep_node_id is None:
        logger.warning(f"Representative not found: {rep_str}")
        return node_id  # æ‰¾ä¸åˆ°ä»£è¡¨ï¼Œä¿æŒåŸæ ·
    
    return rep_node_id
```

### âš ï¸ è¾¹ç•Œæƒ…å†µå¤„ç†

1. **ä»£è¡¨èŠ‚ç‚¹ä¸å­˜åœ¨**
   - è¾“å‡ºè­¦å‘Šæ—¥å¿—
   - ä¿æŒåŸèŠ‚ç‚¹ä¸å˜
   - ä¸ä¸­æ–­å¤„ç†æµç¨‹

2. **MultiDiGraphå¤šé‡è¾¹**
   - åŒä¸€å¯¹èŠ‚ç‚¹å¯èƒ½æœ‰å¤šæ¡è¾¹ï¼ˆä¸åŒrelationï¼‰
   - ä½¿ç”¨`keys=True`éå†æ‰€æœ‰è¾¹
   - æŒ‰relationæ£€æŸ¥æ˜¯å¦é‡å¤

3. **è‡ªå¼•ç”¨è¾¹**
   - å¦‚æœtailå·²ç»æ˜¯ä»£è¡¨èŠ‚ç‚¹
   - `v_rep == v`ï¼Œè·³è¿‡å¤„ç†

---

## åŠŸèƒ½2ï¼šå»é‡ç¤¾åŒºï¼ˆCommunitiesï¼‰æˆå‘˜

### ğŸ“‹ åŠŸèƒ½è¯´æ˜

ç¤¾åŒºï¼ˆCommunityï¼‰æ˜¯ä¸€ç»„ç›¸å…³å®ä½“çš„é›†åˆã€‚å½“å¤šä¸ªclusteræˆå‘˜éƒ½å±äºåŒä¸€ä¸ªcommunityæ—¶ï¼Œéœ€è¦å°†å®ƒä»¬å…¨éƒ¨æ›¿æ¢ä¸ºä»£è¡¨èŠ‚ç‚¹ï¼Œå¹¶å»é‡ã€‚

### ğŸ” å®ç°é€»è¾‘

```python
def apply_to_communities(self) -> None:
    """åº”ç”¨å»é‡æ˜ å°„åˆ°ç¤¾åŒºèŠ‚ç‚¹"""
    
    # éå†æ‰€æœ‰èŠ‚ç‚¹ï¼Œæ‰¾å‡ºç¤¾åŒºèŠ‚ç‚¹
    for node_id, node_data in list(self.graph.nodes(data=True)):
        if node_data.get('label') != 'community':
            continue  # åªå¤„ç†ç¤¾åŒºèŠ‚ç‚¹
        
        # è·å–æ‰€æœ‰æŒ‡å‘è¯¥ç¤¾åŒºçš„èŠ‚ç‚¹ï¼ˆç¤¾åŒºæˆå‘˜ï¼‰
        predecessors = list(self.graph.predecessors(node_id))
        
        preds_to_remove = []  # å¾…åˆ é™¤çš„æ—§æˆå‘˜è¾¹
        edges_to_add = []     # å¾…æ·»åŠ çš„æ–°æˆå‘˜è¾¹
        members_deduplicated = 0
        
        # å¤„ç†æ¯ä¸ªç¤¾åŒºæˆå‘˜
        for pred in predecessors:
            pred_rep = self._get_representative(pred)
            
            if pred_rep != pred:  # éœ€è¦æ›¿æ¢
                # è·å–æˆå‘˜â†’ç¤¾åŒºçš„æ‰€æœ‰è¾¹
                for key, edge_data in self.graph[pred][node_id].items():
                    relation = edge_data.get('relation', '')
                    
                    # æ£€æŸ¥ä»£è¡¨èŠ‚ç‚¹æ˜¯å¦å·²ç»åœ¨ç¤¾åŒºä¸­
                    edge_exists = False
                    if self.graph.has_edge(pred_rep, node_id):
                        for edge_key, rep_edge_data in self.graph[pred_rep][node_id].items():
                            if rep_edge_data.get('relation') == relation:
                                edge_exists = True
                                break
                    
                    # åªæœ‰ä»£è¡¨èŠ‚ç‚¹ä¸åœ¨ç¤¾åŒºä¸­æ—¶æ‰æ·»åŠ 
                    if not edge_exists:
                        edges_to_add.append((pred_rep, node_id, edge_data))
                    
                    # æ ‡è®°åˆ é™¤æ—§æˆå‘˜
                    preds_to_remove.append((pred, node_id, key))
                    members_deduplicated += 1
        
        # åº”ç”¨ä¿®æ”¹
        for u, v, key in preds_to_remove:
            if self.graph.has_edge(u, v):
                self.graph.remove_edge(u, v, key)
        
        for u, v, data in edges_to_add:
            self.graph.add_edge(u, v, **data)
```

### ğŸ“Š å¤„ç†ç¤ºä¾‹

#### ç¤ºä¾‹1ï¼šç¤¾åŒºæˆå‘˜å»é‡

**åŸå§‹ç»“æ„**ï¼š
```
Community: TEè°ƒæ•´æ–¹æ³•ç¤¾åŒº
  â†‘ belongs_to
  â”œâ”€ å¢åŠ TEå€¼ (chunk: PHuCr1nf)
  â”œâ”€ å»¶é•¿TE (chunk: IwfMagF6)
  â””â”€ å»¶é•¿TEå€¼ (chunk: Dwjxk2M8)
```

**Clusterä¿¡æ¯**ï¼š
```
ä¸‰ä¸ªèŠ‚ç‚¹éƒ½åœ¨åŒä¸€ä¸ªclusterä¸­ï¼Œä»£è¡¨ï¼šå»¶é•¿TEå€¼ (chunk: Dwjxk2M8)
```

**å¤„ç†è¿‡ç¨‹**ï¼š

| æ­¥éª¤ | æˆå‘˜ | ä»£è¡¨ | æ“ä½œ |
|------|------|------|------|
| 1 | å¢åŠ TEå€¼ | å»¶é•¿TEå€¼ | åˆ é™¤å¢åŠ TEå€¼â†’ç¤¾åŒºï¼Œæ£€æŸ¥å»¶é•¿TEå€¼æ˜¯å¦åœ¨ç¤¾åŒº |
| 2 | å»¶é•¿TE | å»¶é•¿TEå€¼ | åˆ é™¤å»¶é•¿TEâ†’ç¤¾åŒºï¼Œæ£€æŸ¥å»¶é•¿TEå€¼æ˜¯å¦åœ¨ç¤¾åŒº |
| 3 | å»¶é•¿TEå€¼ | å»¶é•¿TEå€¼ï¼ˆè‡ªå·±ï¼‰ | ä¿ç•™ |

**æ£€æŸ¥é€»è¾‘**ï¼š
```
å¤„ç†"å¢åŠ TEå€¼"ï¼š
  - ä»£è¡¨æ˜¯"å»¶é•¿TEå€¼"
  - æ£€æŸ¥"å»¶é•¿TEå€¼ â†’ ç¤¾åŒº"æ˜¯å¦å­˜åœ¨ï¼Ÿ
  - åŸå›¾ä¸­å·²æœ‰ï¼Œæ‰€ä»¥ä¸æ·»åŠ 
  - åˆ é™¤"å¢åŠ TEå€¼ â†’ ç¤¾åŒº"

å¤„ç†"å»¶é•¿TE"ï¼š
  - ä»£è¡¨æ˜¯"å»¶é•¿TEå€¼"
  - æ£€æŸ¥"å»¶é•¿TEå€¼ â†’ ç¤¾åŒº"æ˜¯å¦å­˜åœ¨ï¼Ÿ
  - å·²ç»å­˜åœ¨ï¼ˆåŸå›¾æˆ–å‰é¢çš„å¤„ç†ï¼‰ï¼Œä¸æ·»åŠ 
  - åˆ é™¤"å»¶é•¿TE â†’ ç¤¾åŒº"
```

**å»é‡å**ï¼š
```
Community: TEè°ƒæ•´æ–¹æ³•ç¤¾åŒº
  â†‘ belongs_to
  â””â”€ å»¶é•¿TEå€¼ (chunk: Dwjxk2M8)
```

#### ç¤ºä¾‹2ï¼šå¤šä¸ªclusterå¤šä¸ªç¤¾åŒº

**åŸå§‹ç»“æ„**ï¼š
```
Community A:
  â†‘ å‘çƒ­ã€å‘çƒ§ (clusterä»£è¡¨: å‘çƒ­)

Community B:
  â†‘ å‘çƒ­ã€ä½“æ¸©å‡é«˜ (clusterä»£è¡¨: å‘çƒ­)
  â†‘ å’³å—½ã€å’³ç—° (clusterä»£è¡¨: å’³å—½)
```

**å¤„ç†å**ï¼š
```
Community A:
  â†‘ å‘çƒ­

Community B:
  â†‘ å‘çƒ­
  â†‘ å’³å—½
```

### ğŸ”‘ å…³é”®ç‚¹ï¼šä¸ºä»€ä¹ˆè¦ç‰¹æ®Šå¤„ç†Communityï¼Ÿ

**åŸå› 1ï¼šé‡å¤æˆå‘˜é—®é¢˜**
```
å¦‚æœä¸ç‰¹æ®Šå¤„ç†ï¼Œæ™®é€šçš„è¾¹æ›¿æ¢ä¼šå¯¼è‡´ï¼š
  ç¤¾åŒº â† å¢åŠ TEå€¼ (åˆ é™¤)
  ç¤¾åŒº â† å»¶é•¿TEå€¼ (å·²å­˜åœ¨)
  ç¤¾åŒº â† å»¶é•¿TE (åˆ é™¤)
  ç¤¾åŒº â† å»¶é•¿TEå€¼ (å·²å­˜åœ¨)
  
ç»“æœï¼šç¤¾åŒºä¸­åªæœ‰ä¸€ä¸ª"å»¶é•¿TEå€¼"âœ“ æ­£ç¡®
```

**åŸå› 2ï¼šå…³ç³»ç±»å‹æ£€æŸ¥**
```
å¯èƒ½æœ‰ä¸åŒç±»å‹çš„å…³ç³»ï¼š
  ç¤¾åŒº â†belongs_toâ”€ å®ä½“A
  ç¤¾åŒº â†representsâ”€ å®ä½“B
  
éœ€è¦æŒ‰relationåˆ†åˆ«æ£€æŸ¥ï¼Œé¿å…è¯¯åˆ¤
```

### âš ï¸ è¾¹ç•Œæƒ…å†µ

1. **ç¤¾åŒºä¸­å·²æœ‰ä»£è¡¨èŠ‚ç‚¹**
   - æ£€æŸ¥æ—¶å‘ç°å·²å­˜åœ¨
   - ä¸é‡å¤æ·»åŠ 
   - åªåˆ é™¤æ—§æˆå‘˜

2. **ä¸åŒrelationçš„è¾¹**
   - åŒä¸€æˆå‘˜å¯èƒ½æœ‰å¤šæ¡åˆ°ç¤¾åŒºçš„è¾¹
   - åˆ†åˆ«å¤„ç†æ¯æ¡è¾¹
   - æŒ‰relationç±»å‹æ£€æŸ¥é‡å¤

3. **ç©ºç¤¾åŒº**
   - å¦‚æœæ‰€æœ‰æˆå‘˜éƒ½è¢«åˆ é™¤
   - ç¤¾åŒºå˜ä¸ºå­¤ç«‹èŠ‚ç‚¹
   - åœ¨cleanupé˜¶æ®µåˆ é™¤

---

## åŠŸèƒ½3ï¼šå¤„ç†keyword_filter_byç‰¹æ®Šå…³ç³»

### ğŸ“‹ åŠŸèƒ½è¯´æ˜

`keyword_filter_by` æ˜¯ä¸€ç§ç‰¹æ®Šçš„å…³ç³»ç±»å‹ï¼Œç”¨äºå…³é”®è¯è¿‡æ»¤ã€‚è¿™ç§å…³ç³»ä¹Ÿéœ€è¦è¿›è¡Œå»é‡å¤„ç†ï¼Œä½†é€»è¾‘ä¸æ™®é€šä¸‰å…ƒç»„ç±»ä¼¼ã€‚

### ğŸ” å®ç°é€»è¾‘

```python
def apply_to_keyword_filter_relations(self) -> None:
    """åº”ç”¨å»é‡æ˜ å°„åˆ°keyword_filter_byå…³ç³»"""
    
    edges_to_add = []
    edges_to_remove = []
    
    # åªå¤„ç†relation="keyword_filter_by"çš„è¾¹
    for u, v, key, data in self.graph.edges(keys=True, data=True):
        relation = data.get('relation', '')
        
        if relation != 'keyword_filter_by':
            continue  # è·³è¿‡å…¶ä»–ç±»å‹çš„è¾¹
        
        # è·å–tailèŠ‚ç‚¹çš„ä»£è¡¨
        v_rep = self._get_representative(v)
        
        if v_rep != v:
            # æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨
            edge_exists = False
            if self.graph.has_edge(u, v_rep):
                for edge_key, edge_data in self.graph[u][v_rep].items():
                    if edge_data.get('relation') == 'keyword_filter_by':
                        edge_exists = True
                        break
            
            if not edge_exists:
                edges_to_add.append((u, v_rep, data))
            
            edges_to_remove.append((u, v, key))
            self.stats['keyword_filter_relations_updated'] += 1
    
    # åº”ç”¨ä¿®æ”¹
    for u, v, key in edges_to_remove:
        self.graph.remove_edge(u, v, key)
    
    for u, v, data in edges_to_add:
        self.graph.add_edge(u, v, **data)
```

### ğŸ“Š å¤„ç†ç¤ºä¾‹

#### keyword_filter_byçš„å…¸å‹ç”¨æ³•

**å›¾ç»“æ„è¯´æ˜**ï¼š
```
å…³é”®è¯èŠ‚ç‚¹ (keyword) --keyword_filter_by--> å®ä½“èŠ‚ç‚¹ (entity)
```

è¿™è¡¨ç¤ºè¯¥å…³é”®è¯é€šè¿‡æŸä¸ªå®ä½“æ¥è¿‡æ»¤æˆ–é™å®šå«ä¹‰ã€‚

**ç¤ºä¾‹åœºæ™¯**ï¼š
```
åŸå§‹ï¼š
  Keyword: "TE" --keyword_filter_by--> "å¢åŠ TEå€¼"
  Keyword: "TE" --keyword_filter_by--> "å»¶é•¿TE"
  Keyword: "TE" --keyword_filter_by--> "å»¶é•¿TEå€¼"

Cluster: [å¢åŠ TEå€¼, å»¶é•¿TE, å»¶é•¿TEå€¼]ï¼Œä»£è¡¨ï¼šå»¶é•¿TEå€¼

å¤„ç†åï¼š
  Keyword: "TE" --keyword_filter_by--> "å»¶é•¿TEå€¼"
```

### ğŸ”‘ ä¸ºä»€ä¹ˆå•ç‹¬å¤„ç†è¿™ä¸ªå…³ç³»ï¼Ÿ

**åŸå› 1ï¼šè¯­ä¹‰é‡è¦æ€§**
- `keyword_filter_by` æ˜¯å›¾è°±ä¸­çš„ç‰¹æ®Šå…³ç³»
- ç”¨äºå…³é”®è¯æ¶ˆæ­§å’Œç²¾ç¡®æ£€ç´¢
- é”™è¯¯å¤„ç†ä¼šå½±å“æ£€ç´¢å‡†ç¡®æ€§

**åŸå› 2ï¼šç»Ÿè®¡è¿½è¸ª**
- å•ç‹¬ç»Ÿè®¡è¿™ç±»å…³ç³»çš„æ›´æ–°æ•°é‡
- ä¾¿äºè¯„ä¼°å»é‡å¯¹å…³é”®è¯ç³»ç»Ÿçš„å½±å“

**åŸå› 3ï¼šå¯æ‰©å±•æ€§**
- æœªæ¥å¯èƒ½éœ€è¦ç‰¹æ®Šçš„å¤„ç†é€»è¾‘
- ä¾‹å¦‚ï¼šå…³é”®è¯æƒé‡è°ƒæ•´ã€é¢‘ç‡æ›´æ–°ç­‰

### âš ï¸ ä¸æ™®é€šè¾¹çš„åŒºåˆ«

| ç‰¹æ€§ | æ™®é€šè¾¹ | keyword_filter_by |
|------|--------|-------------------|
| å¤„ç†æ–¹å¼ | ç›¸åŒ | ç›¸åŒ |
| ç»Ÿè®¡åˆ†ç±» | edges_updated | keyword_filter_relations_updated |
| ä¸šåŠ¡å«ä¹‰ | ä¸€èˆ¬å…³ç³» | å…³é”®è¯è¿‡æ»¤å…³ç³» |
| æ‰©å±•æ€§ | é€šç”¨å¤„ç† | å¯åŠ å…¥ç‰¹æ®Šé€»è¾‘ |

---

## åŠŸèƒ½4ï¼šè‡ªåŠ¨å»é‡ - é¿å…åˆ›å»ºé‡å¤è¾¹

### ğŸ“‹ åŠŸèƒ½è¯´æ˜

åœ¨æ›¿æ¢èŠ‚ç‚¹æ—¶ï¼Œå¯èƒ½å‡ºç°å¤šä¸ªä¸åŒçš„tailèŠ‚ç‚¹éƒ½æ˜ å°„åˆ°åŒä¸€ä¸ªä»£è¡¨èŠ‚ç‚¹ã€‚ä¸ºé¿å…åˆ›å»ºé‡å¤çš„è¾¹ï¼Œéœ€è¦åœ¨æ·»åŠ å‰æ£€æŸ¥è¾¹æ˜¯å¦å·²å­˜åœ¨ã€‚

### ğŸ” æ£€æŸ¥é€»è¾‘

```python
# æ ¸å¿ƒæ£€æŸ¥ä»£ç 
def check_edge_exists(u, v_rep, relation):
    """æ£€æŸ¥è¾¹æ˜¯å¦å·²å­˜åœ¨"""
    edge_exists = False
    
    # 1. å¿«é€Ÿæ£€æŸ¥ï¼šuå’Œv_repä¹‹é—´æ˜¯å¦æœ‰ä»»ä½•è¾¹
    if self.graph.has_edge(u, v_rep):
        
        # 2. è¯¦ç»†æ£€æŸ¥ï¼šéå†æ‰€æœ‰è¾¹ï¼Œæ¯”è¾ƒrelation
        for edge_key, edge_data in self.graph[u][v_rep].items():
            if edge_data.get('relation') == relation:
                edge_exists = True
                break
    
    return edge_exists
```

### ğŸ“Š è¯¦ç»†ç¤ºä¾‹

#### ç¤ºä¾‹1ï¼šåŒä¸€clusterçš„å¤šä¸ªæˆå‘˜

**åŸå§‹å›¾**ï¼š
```
é­”è§’æ•ˆåº” --è§£å†³æ–¹æ¡ˆä¸º--> å¢åŠ TEå€¼ (chunk: A)
é­”è§’æ•ˆåº” --è§£å†³æ–¹æ¡ˆä¸º--> å»¶é•¿TE (chunk: B)
é­”è§’æ•ˆåº” --è§£å†³æ–¹æ¡ˆä¸º--> å»¶é•¿TEå€¼ (chunk: C)
```

**Cluster**ï¼šæ‰€æœ‰ä¸‰ä¸ªèŠ‚ç‚¹éƒ½æ˜ å°„åˆ°"å»¶é•¿TEå€¼"

**å¤„ç†æµç¨‹**ï¼š

| è¿­ä»£ | å½“å‰è¾¹ | ç›®æ ‡æ“ä½œ | æ£€æŸ¥ç»“æœ | æœ€ç»ˆæ“ä½œ |
|------|--------|----------|----------|----------|
| 1 | é­”è§’æ•ˆåº”â†’å¢åŠ TEå€¼ | æ›¿æ¢ä¸ºâ†’å»¶é•¿TEå€¼ | ä¸å­˜åœ¨ | âœ… æ·»åŠ æ–°è¾¹ |
| 2 | é­”è§’æ•ˆåº”â†’å»¶é•¿TE | æ›¿æ¢ä¸ºâ†’å»¶é•¿TEå€¼ | **å·²å­˜åœ¨** | âŒ ä¸æ·»åŠ ï¼ˆé¿å…é‡å¤ï¼‰ |
| 3 | é­”è§’æ•ˆåº”â†’å»¶é•¿TEå€¼ | ä¿æŒâ†’å»¶é•¿TEå€¼ | æ˜¯è‡ªå·± | ğŸ”„ è·³è¿‡å¤„ç† |

**å…³é”®ç‚¹**ï¼š
- ç¬¬1æ¬¡è¿­ä»£ï¼šæ·»åŠ "é­”è§’æ•ˆåº”â†’å»¶é•¿TEå€¼"
- ç¬¬2æ¬¡è¿­ä»£ï¼šæ£€æŸ¥å‘ç°å·²å­˜åœ¨ï¼Œ**ä¸å†æ·»åŠ **
- ç¬¬3æ¬¡è¿­ä»£ï¼šä»£è¡¨æ˜¯è‡ªå·±ï¼Œç›´æ¥è·³è¿‡

**ç»“æœ**ï¼š
```
é­”è§’æ•ˆåº” --è§£å†³æ–¹æ¡ˆä¸º--> å»¶é•¿TEå€¼ (chunk: C)
```
åªæœ‰1æ¡è¾¹ï¼

#### ç¤ºä¾‹2ï¼šMultiDiGraphå¤šé‡è¾¹æƒ…å†µ

**åŸå§‹å›¾**ï¼š
```
è‚ºç‚ --ç—‡çŠ¶åŒ…æ‹¬--> å‘çƒ­
è‚ºç‚ --ç—‡çŠ¶åŒ…æ‹¬--> å‘çƒ§
è‚ºç‚ --å¹¶å‘ç—‡ä¸º--> å‘çƒ­
```

**Cluster**ï¼š[å‘çƒ­, å‘çƒ§]ï¼Œä»£è¡¨ï¼šå‘çƒ­

**å¤„ç†**ï¼š

| è¾¹ | Relation | æ›¿æ¢ä¸º | æ£€æŸ¥ | æ“ä½œ |
|---|----------|--------|------|------|
| è‚ºç‚â†’å‘çƒ­ | ç—‡çŠ¶åŒ…æ‹¬ | å‘çƒ­ï¼ˆè‡ªå·±ï¼‰ | - | ä¿ç•™ |
| è‚ºç‚â†’å‘çƒ§ | ç—‡çŠ¶åŒ…æ‹¬ | å‘çƒ­ | âœ“å·²å­˜åœ¨ï¼ˆç›¸åŒrelationï¼‰ | åˆ é™¤å‘çƒ§ï¼Œä¸æ·»åŠ  |
| è‚ºç‚â†’å‘çƒ­ | å¹¶å‘ç—‡ä¸º | å‘çƒ­ï¼ˆè‡ªå·±ï¼‰ | - | ä¿ç•™ |

**ç»“æœ**ï¼š
```
è‚ºç‚ --ç—‡çŠ¶åŒ…æ‹¬--> å‘çƒ­
è‚ºç‚ --å¹¶å‘ç—‡ä¸º--> å‘çƒ­
```
ä¸¤æ¡è¾¹ä¿ç•™ï¼ˆä¸åŒrelationï¼‰ï¼

### ğŸ”‘ ä¸ºä»€ä¹ˆéœ€è¦æŒ‰relationæ£€æŸ¥ï¼Ÿ

**é”™è¯¯åšæ³•**ï¼šåªæ£€æŸ¥èŠ‚ç‚¹å¯¹
```python
if self.graph.has_edge(u, v_rep):
    edge_exists = True  # âŒ é”™è¯¯ï¼
```

**é—®é¢˜**ï¼š
```
åŸå›¾æœ‰ï¼šA --relation1--> B
è¦æ·»åŠ ï¼šA --relation2--> B

é”™è¯¯åˆ¤æ–­ä¸º"å·²å­˜åœ¨"ï¼Œå¯¼è‡´relation2ä¸¢å¤±ï¼
```

**æ­£ç¡®åšæ³•**ï¼šæ£€æŸ¥(u, v_rep, relation)ä¸‰å…ƒç»„
```python
for edge_key, edge_data in self.graph[u][v_rep].items():
    if edge_data.get('relation') == relation:
        edge_exists = True  # âœ“ æ­£ç¡®ï¼
```

### ğŸ“ å»é‡ç®—æ³•å¤æ‚åº¦åˆ†æ

**æ—¶é—´å¤æ‚åº¦**ï¼š
```
å¯¹äºæ¯æ¡è¾¹ï¼š
  1. æŸ¥æ‰¾ä»£è¡¨èŠ‚ç‚¹: O(1) - å“ˆå¸Œè¡¨æŸ¥æ‰¾
  2. æ£€æŸ¥è¾¹æ˜¯å¦å­˜åœ¨:
     - has_edge(): O(1)
     - éå†uâ†’vçš„è¾¹: O(k)ï¼Œkæ˜¯uâ†’vçš„è¾¹æ•°
  
æ€»è®¡ï¼šO(E Ã— k)
  E = æ€»è¾¹æ•°
  k = å¹³å‡æ¯å¯¹èŠ‚ç‚¹çš„è¾¹æ•°ï¼ˆé€šå¸¸å¾ˆå°ï¼Œ~1-3ï¼‰
```

**ç©ºé—´å¤æ‚åº¦**ï¼š
```
- edges_to_add: O(E')ï¼ŒE'æ˜¯éœ€è¦æ›¿æ¢çš„è¾¹æ•°
- edges_to_remove: O(E')
- node_mapping: O(N)ï¼ŒNæ˜¯clusteræˆå‘˜æ€»æ•°

æ€»è®¡ï¼šO(E' + N)
```

### âš ï¸ è¾¹ç•Œæƒ…å†µ

#### æƒ…å†µ1ï¼šæ‰€æœ‰æˆå‘˜éƒ½æ˜ å°„åˆ°åŸå›¾ä¸­ä¸å­˜åœ¨çš„èŠ‚ç‚¹
```
åŸå›¾ï¼šA â†’ B, A â†’ C
Cluster: [B, C, D]ï¼Œä»£è¡¨ï¼šD

é—®é¢˜ï¼šDä¸åœ¨åŸå›¾ä¸­ï¼
å¤„ç†ï¼š_get_representative()è¿”å›åŸèŠ‚ç‚¹IDï¼Œä¸æ›¿æ¢
```

#### æƒ…å†µ2ï¼šå¾ªç¯å¼•ç”¨
```
åŸå›¾ï¼šA â†’ B â†’ C â†’ A (ç¯)
Cluster: [B, X]ï¼Œä»£è¡¨ï¼šX

å¤„ç†ï¼š
  A â†’ B å˜ä¸º A â†’ X
  X â†’ C (æ–°è¾¹ï¼Œå¦‚æœBâ†’Cå­˜åœ¨)
  C â†’ A (ä¿æŒä¸å˜)
```

#### æƒ…å†µ3ï¼šè‡ªç¯è¾¹
```
åŸå›¾ï¼šA â†’ A (è‡ªç¯)
Cluster: [A, B]ï¼Œä»£è¡¨ï¼šB

å¤„ç†ï¼šA â†’ A å˜ä¸º A â†’ B
```

---

## ğŸ¯ ç»¼åˆç¤ºä¾‹ï¼šå®Œæ•´æµç¨‹

### åœºæ™¯ï¼šåŒ»å­¦çŸ¥è¯†å›¾è°±å»é‡

**åŸå§‹å›¾è°±**ï¼š
```
[ä¸‰å…ƒç»„]
MRIä¼ªå½± --ç±»å‹åŒ…æ‹¬--> é­”è§’æ•ˆåº”
é­”è§’æ•ˆåº” --è§£å†³æ–¹æ¡ˆä¸º--> å¢åŠ TEå€¼ (chunk: A)
é­”è§’æ•ˆåº” --è§£å†³æ–¹æ¡ˆä¸º--> å»¶é•¿TE (chunk: B)
é­”è§’æ•ˆåº” --è§£å†³æ–¹æ¡ˆä¸º--> å»¶é•¿TEå€¼ (chunk: C)
é­”è§’æ•ˆåº” --è§£å†³æ–¹æ¡ˆä¸º--> æ”¹å˜ä½“ä½ (chunk: B)
é­”è§’æ•ˆåº” --è§£å†³æ–¹æ¡ˆä¸º--> æ”¹å˜æ‰«æä½“ä½ (chunk: C)

[Community]
TEè°ƒæ•´ç¤¾åŒº:
  â† å¢åŠ TEå€¼ (chunk: A)
  â† å»¶é•¿TE (chunk: B)
  â† å»¶é•¿TEå€¼ (chunk: C)

[Keyword]
å…³é”®è¯"TE" --keyword_filter_by--> å¢åŠ TEå€¼ (chunk: A)
å…³é”®è¯"TE" --keyword_filter_by--> å»¶é•¿TE (chunk: B)
```

**Dedupç»“æœ**ï¼š
```json
{
  "cluster_0": {
    "member": [
      "å¢åŠ TEå€¼ (chunk id: A) [entity]",
      "å»¶é•¿TE (chunk id: B) [entity]",
      "å»¶é•¿TEå€¼ (chunk id: C) [entity]"  // ä»£è¡¨
    ]
  },
  "cluster_1": {
    "member": [
      "æ”¹å˜ä½“ä½ (chunk id: B) [entity]",
      "æ”¹å˜æ‰«æä½“ä½ (chunk id: C) [entity]"  // ä»£è¡¨
    ]
  }
}
```

**å¤„ç†æ­¥éª¤**ï¼š

#### æ­¥éª¤1ï¼šæ„å»ºæ˜ å°„
```python
node_mapping = {
    "å¢åŠ TEå€¼ (chunk id: A) [entity]": "å»¶é•¿TEå€¼ (chunk id: C) [entity]",
    "å»¶é•¿TE (chunk id: B) [entity]": "å»¶é•¿TEå€¼ (chunk id: C) [entity]",
    "å»¶é•¿TEå€¼ (chunk id: C) [entity]": "å»¶é•¿TEå€¼ (chunk id: C) [entity]",
    "æ”¹å˜ä½“ä½ (chunk id: B) [entity]": "æ”¹å˜æ‰«æä½“ä½ (chunk id: C) [entity]",
    "æ”¹å˜æ‰«æä½“ä½ (chunk id: C) [entity]": "æ”¹å˜æ‰«æä½“ä½ (chunk id: C) [entity]",
}
```

#### æ­¥éª¤2ï¼šå¤„ç†ä¸‰å…ƒç»„
```
å¤„ç†: é­”è§’æ•ˆåº” â†’ å¢åŠ TEå€¼
  ä»£è¡¨: å»¶é•¿TEå€¼
  æ£€æŸ¥: é­”è§’æ•ˆåº” â†’ å»¶é•¿TEå€¼ ä¸å­˜åœ¨
  æ“ä½œ: åˆ é™¤"é­”è§’æ•ˆåº” â†’ å¢åŠ TEå€¼"ï¼Œæ·»åŠ "é­”è§’æ•ˆåº” â†’ å»¶é•¿TEå€¼"

å¤„ç†: é­”è§’æ•ˆåº” â†’ å»¶é•¿TE
  ä»£è¡¨: å»¶é•¿TEå€¼
  æ£€æŸ¥: é­”è§’æ•ˆåº” â†’ å»¶é•¿TEå€¼ å·²å­˜åœ¨ï¼
  æ“ä½œ: åˆ é™¤"é­”è§’æ•ˆåº” â†’ å»¶é•¿TE"ï¼Œä¸æ·»åŠ 

å¤„ç†: é­”è§’æ•ˆåº” â†’ å»¶é•¿TEå€¼
  ä»£è¡¨: å»¶é•¿TEå€¼ï¼ˆè‡ªå·±ï¼‰
  æ“ä½œ: è·³è¿‡

å¤„ç†: é­”è§’æ•ˆåº” â†’ æ”¹å˜ä½“ä½
  ä»£è¡¨: æ”¹å˜æ‰«æä½“ä½
  æ£€æŸ¥: é­”è§’æ•ˆåº” â†’ æ”¹å˜æ‰«æä½“ä½ ä¸å­˜åœ¨
  æ“ä½œ: åˆ é™¤"é­”è§’æ•ˆåº” â†’ æ”¹å˜ä½“ä½"ï¼Œæ·»åŠ "é­”è§’æ•ˆåº” â†’ æ”¹å˜æ‰«æä½“ä½"

å¤„ç†: é­”è§’æ•ˆåº” â†’ æ”¹å˜æ‰«æä½“ä½
  ä»£è¡¨: æ”¹å˜æ‰«æä½“ä½ï¼ˆè‡ªå·±ï¼‰
  æ“ä½œ: è·³è¿‡
```

**ä¸‰å…ƒç»„ç»“æœ**ï¼š
```
MRIä¼ªå½± --ç±»å‹åŒ…æ‹¬--> é­”è§’æ•ˆåº”
é­”è§’æ•ˆåº” --è§£å†³æ–¹æ¡ˆä¸º--> å»¶é•¿TEå€¼ (chunk: C)
é­”è§’æ•ˆåº” --è§£å†³æ–¹æ¡ˆä¸º--> æ”¹å˜æ‰«æä½“ä½ (chunk: C)
```

#### æ­¥éª¤3ï¼šå¤„ç†Community
```
å¤„ç†TEè°ƒæ•´ç¤¾åŒºçš„æˆå‘˜:

æˆå‘˜: å¢åŠ TEå€¼
  ä»£è¡¨: å»¶é•¿TEå€¼
  æ£€æŸ¥: å»¶é•¿TEå€¼ â†’ ç¤¾åŒºï¼Œå·²å­˜åœ¨ï¼ˆåŸå›¾ï¼‰
  æ“ä½œ: åˆ é™¤"å¢åŠ TEå€¼ â†’ ç¤¾åŒº"

æˆå‘˜: å»¶é•¿TE
  ä»£è¡¨: å»¶é•¿TEå€¼
  æ£€æŸ¥: å»¶é•¿TEå€¼ â†’ ç¤¾åŒºï¼Œå·²å­˜åœ¨
  æ“ä½œ: åˆ é™¤"å»¶é•¿TE â†’ ç¤¾åŒº"

æˆå‘˜: å»¶é•¿TEå€¼
  ä»£è¡¨: å»¶é•¿TEå€¼ï¼ˆè‡ªå·±ï¼‰
  æ“ä½œ: ä¿ç•™
```

**Communityç»“æœ**ï¼š
```
TEè°ƒæ•´ç¤¾åŒº:
  â† å»¶é•¿TEå€¼ (chunk: C)
```

#### æ­¥éª¤4ï¼šå¤„ç†keyword_filter_by
```
å¤„ç†: å…³é”®è¯"TE" â†’ å¢åŠ TEå€¼
  ä»£è¡¨: å»¶é•¿TEå€¼
  æ£€æŸ¥: å…³é”®è¯"TE" â†’ å»¶é•¿TEå€¼ ä¸å­˜åœ¨
  æ“ä½œ: åˆ é™¤åŸè¾¹ï¼Œæ·»åŠ "å…³é”®è¯'TE' â†’ å»¶é•¿TEå€¼"

å¤„ç†: å…³é”®è¯"TE" â†’ å»¶é•¿TE
  ä»£è¡¨: å»¶é•¿TEå€¼
  æ£€æŸ¥: å…³é”®è¯"TE" â†’ å»¶é•¿TEå€¼ å·²å­˜åœ¨ï¼
  æ“ä½œ: åˆ é™¤åŸè¾¹ï¼Œä¸æ·»åŠ 
```

**Keywordç»“æœ**ï¼š
```
å…³é”®è¯"TE" --keyword_filter_by--> å»¶é•¿TEå€¼ (chunk: C)
```

#### æ­¥éª¤5ï¼šæ¸…ç†å­¤ç«‹èŠ‚ç‚¹
```
æ£€æŸ¥å­¤ç«‹èŠ‚ç‚¹ï¼ˆå…¥åº¦å’Œå‡ºåº¦éƒ½ä¸º0ï¼‰:
  - å¢åŠ TEå€¼ (chunk: A): å­¤ç«‹ â†’ åˆ é™¤
  - å»¶é•¿TE (chunk: B): å­¤ç«‹ â†’ åˆ é™¤
  - æ”¹å˜ä½“ä½ (chunk: B): å­¤ç«‹ â†’ åˆ é™¤
```

### ğŸ“Š æœ€ç»ˆç»Ÿè®¡
```
Deduplication Statistics:
  Total clusters processed: 2
  Total members in clusters: 5
  Edges updated: 4
  Communities updated: 1
  Community members deduplicated: 2
  Keyword_filter_by relations updated: 2
  Isolated nodes removed: 3
  Graph size: 8 â†’ 5 nodes (3 removed)
  Graph edges: 10 â†’ 5 edges (5 removed)
```

---

## ğŸ”§ ä»£ç è®¾è®¡åŸåˆ™

### 1. æ‰¹é‡å¤„ç†åŸåˆ™
```python
# âœ“ æ­£ç¡®ï¼šå…ˆæ”¶é›†ï¼Œåæ‰¹é‡ä¿®æ”¹
edges_to_remove = []
edges_to_add = []

for edge in graph.edges():
    edges_to_remove.append(...)
    edges_to_add.append(...)

# æ‰¹é‡åˆ é™¤
for edge in edges_to_remove:
    graph.remove_edge(...)

# æ‰¹é‡æ·»åŠ 
for edge in edges_to_add:
    graph.add_edge(...)
```

**åŸå› **ï¼šé¿å…åœ¨éå†æ—¶ä¿®æ”¹å›¾ç»“æ„ï¼Œé˜²æ­¢è¿­ä»£å™¨å¤±æ•ˆ

### 2. å…ˆåˆ ååŠ åŸåˆ™
```python
# æ­£ç¡®é¡ºåº
for edge in edges_to_remove:
    graph.remove_edge(...)  # å…ˆåˆ é™¤

for edge in edges_to_add:
    graph.add_edge(...)     # åæ·»åŠ 
```

**åŸå› **ï¼šç¡®ä¿æ£€æŸ¥"æ˜¯å¦å­˜åœ¨"çš„é€»è¾‘æ­£ç¡®

### 3. å®‰å…¨æ£€æŸ¥åŸåˆ™
```python
# åˆ é™¤å‰æ£€æŸ¥
if self.graph.has_edge(u, v):
    self.graph.remove_edge(u, v, key)

# æŸ¥æ‰¾å‰æ£€æŸ¥
if node_id in self.graph.nodes():
    data = self.graph.nodes[node_id]
```

**åŸå› **ï¼šé˜²æ­¢KeyErrorç­‰å¼‚å¸¸

### 4. æ—¥å¿—è®°å½•åŸåˆ™
```python
if rep_node_id is None:
    logger.warning(f"Representative not found: {rep_str}")
    return node_id  # ç»§ç»­å¤„ç†ï¼Œä¸ä¸­æ–­
```

**åŸå› **ï¼šä¾¿äºè°ƒè¯•å’Œé—®é¢˜è¿½è¸ª

---

## ğŸ’¡ æ€»ç»“

| åŠŸèƒ½ | æ ¸å¿ƒé€»è¾‘ | å…³é”®ç‚¹ |
|------|----------|--------|
| **ä¸‰å…ƒç»„å»é‡** | æ›¿æ¢tailä¸ºä»£è¡¨ | æŒ‰relationæ£€æŸ¥é‡å¤ |
| **ç¤¾åŒºå»é‡** | æ›¿æ¢æˆå‘˜ä¸ºä»£è¡¨ | å¯èƒ½å¤šä¸ªæˆå‘˜æ˜ å°„åˆ°ä¸€ä¸ªä»£è¡¨ |
| **ç‰¹æ®Šå…³ç³»** | å•ç‹¬å¤„ç†keyword_filter_by | ä¾¿äºç»Ÿè®¡å’Œæ‰©å±• |
| **é¿å…é‡å¤** | æ·»åŠ å‰æ£€æŸ¥(u, v, relation) | MultiDiGraphæŒ‰relationåŒºåˆ† |

è¿™å››ä¸ªåŠŸèƒ½ååŒå·¥ä½œï¼Œç¡®ä¿å›¾è°±å»é‡çš„å®Œæ•´æ€§å’Œä¸€è‡´æ€§ï¼
