# 事件模式发现引擎

本说明文档介绍如何基于 ``utils/event_discovery.py`` 提供的规则引擎，对
LLM 抽取的知识图谱三元组进行“事件”层面的自动整合，串联出对象/动作/
状态的结构化语义，并补充跨三元组的推理关系。

## 背景

以 MRI 化学位移伪影场景为例，原始三元组可能是：

- `化学位移伪影 —(解决方案为)→ 采用高带宽`
- `高带宽 —(影响)→ 信噪比`

两个三元组之间存在显式/隐式的语义桥接：尾实体“采用高带宽”既是一个
动作短语，又包含“高带宽”这一状态实体，状态实体继续影响“信噪比”等
指标。事件模式发现器的目标是把这些信息抽象成：

```
事件: 化学位移伪影-提高带宽-高带宽
  - 动作实体: 提高带宽
  - 对象实体: 带宽
  - 状态实体: 高带宽
  - 继承关系: 事件通过状态影响信噪比
```

这样既保留原始三元组，又形成了“事件”这一更高阶的语义对象，便于后续
的推理、检索或自动化建模。

## 核心流程

1. **触发三元组筛选**：默认对关系属于“解决方案为 / 处理方法 / 优化策略”等
   类别的边进行处理，可通过 `EventDiscoveryConfig.trigger_relations` 自定义。
2. **动词解析**：对尾实体（多为动作短语）识别动词前缀（如“采用”“提高”），
   并根据前缀和状态修饰语映射到规范化动作（如“高带宽”推断出“提高带宽”）。
3. **状态/对象拆分**：对短语尾部进行修饰语拆分，提取状态实体（`高带宽`）和基
   础对象实体（`带宽`）。在图谱中优先复用已有节点，缺失时会自动生成。
4. **事件节点构造**：以 `(源实体, 规范化动作, 状态)` 作为签名生成事件节点，保
   留来源三元组信息并设定默认置信度。
5. **结构连线**：新增如下推理关系：
   - 源实体 → 事件 (关系示例：`解决方案事件`)
   - 事件 → 动作 / 状态
   - 动作 → 对象
   - 状态 → 事件 (反向引用，便于遍历)
   - 原始动作短语 → 规范化动作 (`normalises_to`)
6. **影响传播**：把状态实体指向的原始外部边（例如 `高带宽 → 信噪比`）继承到
   事件层，生成 `事件 → 信噪比` 的推理边，关系名默认带前缀
   `event_via_state:`，以区分推断来源。

## 快速上手

```bash
python3 example_event_pattern_discovery.py
```

示例脚本会打印：

- 原始节点/关系
- 自动发现的事件及其动作/状态/对象实体
- 推断出的事件级别影响关系

## 集成方式

```python
import networkx as nx
from utils.event_discovery import discover_event_patterns, EventDiscoveryConfig

graph = load_your_graph()
config = EventDiscoveryConfig()
patterns = discover_event_patterns(graph, config)

for pattern in patterns:
    print(graph.nodes[pattern.event_node]["properties"]["name"])
```

`discover_event_patterns` 会直接在传入的图上添加新节点/边；返回值包含每个事件
的结构信息和继承出的目标节点，便于进一步处理或记录。

## 可配置项

| 配置字段 | 作用 | 默认值 |
|----------|------|--------|
| `trigger_relations` | 触发事件拆解的关系集合 | `{"解决方案为", "处理方法", ...}` |
| `action_prefixes` | 识别动作短语的动词前缀列表 | 见源码 |
| `modifier_to_action` | 状态修饰语到规范动作的映射 | `{"高": "提高", ...}` |
| `event_to_target_relation_template` | 事件继承状态外部边时的关系模板 | `"event_via_state:{relation}"` |
| `default_confidence` | 新建事件节点的默认置信度 | `0.65` |

需要适配特定领域（例如心血管、材料科学等）时，建议自定义：

- 动词前缀列表（加入“施加”“注入”等领域动词）
- 状态修饰符→动作映射（如“高剂量”→“增加剂量”）
- 触发关系映射（配置 `source_to_event_relation_map`，使输出关系更贴合业务语义）

## 注意事项

- 引擎不替代 LLM 理解，只在已有三元组上做**可解释的规则推理**。
- 若原始图谱缺失必要节点（例如没有“高带宽”实体），引擎会生成新节点并在属性中
  标记 `generated: True`，便于后续审核或补充语料。
- 在大规模图谱上运行前，可先在抽样数据集（如 1% 节点）上验证效果，必要时扩充
  动词/修饰词词典以提升召回率。

## 后续拓展方向

1. **LLM 辅助补充**：当规则无法解析动作短语时，可调用 LLM 解析结构并反馈；接口
   可在 `_extract_components` 中扩展。
2. **评分机制**：结合三元组置信度或来源信息，对事件打分，便于在下游模型中过滤。
3. **图数据库落地**：若使用 Neo4j / HugeGraph 等，可将新增节点与关系批量导出，构
   建事件层数据视图。

---

如需进一步集成到现有知识图谱构建流程，可参考 `utils/event_discovery.py` 中的代码
结构，或在 issue 中反馈具体场景，我们可基于规则集或 Prompt 进一步优化。

